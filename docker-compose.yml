version: "3.2"
services:
  app-server:
    # Configuration for building the docker image for the backend service
    build:
      context: amazing-application # Use an image built from the specified dockerfile in the `polling-app-server` directory.
      dockerfile: Dockerfile
    ports:
      - "8080:8080" # Forward the exposed port 8080 on the container to port 8080 on the host machine
    restart: always
    depends_on:
      - amazing-db # This service depends on mysql. Start that first.
      - amazing-redis
    environment: # Pass environment variables to the service
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/polls?useSSL=false&serverTimezone=UTC&useLegacyDatetimeCode=false
      SPRING_DATASOURCE_USERNAME: callicoder
      SPRING_DATASOURCE_PASSWORD: callicoder
    networks: # Networks to join (Services on the same network can communicate with each other using their name)
      - backend
  amazing-db:
    container_name: amazing-db
    image: postgres:latest
    env_file:
      - ./Docker/amazing-db/amazing-db.env
    ports:
      - ${POSTGRES_PORT}:5432
    volumes:
      - ${POSTGRES_VOLUME}:/var/lib/postgresql/data
      - ./Docker/amazing-db/init_scripts/:/docker-entrypoint-initdb.d/
    networks:
      - default
  amazing-redis:
    container_name: amazing-cache
    image: redis:latest
    env_file:
      - ./Docker/amazing-cache/amazing-cache.env
    ports:
      - ${MONGODB_PORT}:${MONGODB_PORT}
    volumes:
      - ${MONGODB_VOLUME}:/data/db
      - ./Docker/geopolis-metadata-store-db/init_scripts:/docker-entrypoint-initdb.d/
    command: mongod
    networks:
      - default